<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="manifest.webmanifest?v=v4.6.6-20250817031027"/>
<title>Brainlock</title>
<style>
:root {--bg:#0b0b0f;--panel:#121218;--muted:#8a8a96;--text:#f5f7fa;--accent:#fff;--ok:#73e2a7;--miss:#ff7575;--line:rgba(255,255,255,.08);--pill:9999px;--radius:18px;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{background:var(--bg);color:var(--text);margin:0;font-family:-apple-system,Inter,system-ui,sans-serif;min-height:100dvh}
.app{display:grid;grid-template-rows:auto auto 1fr auto;min-height:100dvh}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px}
.iconbtn{width:44px;height:44px;border-radius:var(--pill);border:1px solid var(--line);background:#1a1a22;color:var(--text)}
.skate-top{padding:6px 12px 0;display:flex;justify-content:center;gap:12px}
.skate-top span{font-weight:900;font-size:clamp(64px,12vw,96px);opacity:.28;letter-spacing:2px}
.skate-top span.on{opacity:1;color:var(--miss)}
.content{padding:0 16px 24px}
.card{background:#121218;border:1px solid var(--line);border-radius:18px;padding:14px}
.huge{font-size:32px;font-weight:900}
.muted{color:var(--muted);font-size:13px}
.badge{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
.btnrow{display:flex;gap:10px;flex-wrap:wrap}
.cta{flex:1 1 0;padding:14px 16px;border-radius:999px;border:none;font-weight:900}
.cta.primary{background:var(--accent);color:#000}
.cta.ok{background:var(--ok);color:#000}
.cta.miss{background:var(--miss);color:#000}
.cta.ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)}
.attempts{display:flex;gap:8px}
.dot{width:18px;height:18px;border:2px solid rgba(255,255,255,.25);border-radius:50%;display:grid;place-items:center}
.dot.active{border-color:#4da3ff}
.dot .m{font-size:12px}
.hidden{display:none!important}
.tray{position:sticky;bottom:0;padding:16px;background:linear-gradient(180deg,transparent,rgba(11,11,15,.9) 40%,rgba(11,11,15,1))}
.tray-inner{background:#121218;border:1px solid var(--line);border-radius:24px;padding:14px}
.sheet{border:none;width:100%;max-width:720px;border-radius:24px 24px 0 0;position:fixed;bottom:0;left:50%;transform:translateX(-50%);background:#121218;color:var(--text)}
.sheet::backdrop{background:rgba(0,0,0,.55)}
.row{display:flex;gap:10px;align-items:center}
.row-sb{display:flex;justify-content:space-between;gap:10px;align-items:center}
.subs{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 14px}
.toggle{padding:10px 14px;border:1px solid rgba(255,255,255,.14);border-radius:999px;cursor:pointer}
.toggle.on{background:#1f1f27;border-color:rgba(255,255,255,.28)}
.scorepeek{font-size:12px;color:var(--muted);text-decoration:underline dotted;cursor:pointer}
.sectionhead{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
.sectionhead .label{font-weight:600}
.sectionhead .row{gap:6px}
pre.debug{font-size:11px;white-space:pre-wrap;background:#0e0e14;border:1px solid var(--line);padding:10px;border-radius:12px}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div>Brainlock</div>
    <div class="row">
      <button id="debugBtn" class="iconbtn" title="Debug">DBG</button>
      <button id="settingsBtn" class="iconbtn" title="Settings">⚙️</button>
    </div>
  </div>

  <div class="skate-top" id="skTop"><span>S</span><span>K</span><span>A</span><span>T</span><span>E</span></div>

  <div class="content">
    <div class="card">
      <div class="row-sb">
        <div>
          <div id="trickText" class="huge">Tap Start Session</div>
          <div class="row">
            <div id="subText" class="muted">You have 3 tries per trick.</div>
            <div id="attempts" class="attempts"></div>
          </div>
          <div id="scorePeek" class="scorepeek"></div>
        </div>
        <div>
          <div class="badge" id="levelBadge">Level 1</div>
          <div class="badge" id="modeBadge">Mode: SKATE</div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><div class="muted" style="font-size:11px">Score</div><div id="scoreVal">0</div></div>
        <div><div class="muted" style="font-size:11px">High</div><div id="highVal">0</div></div>
        <div><div class="muted" style="font-size:11px">Streak</div><div id="streakVal">0</div></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="btnrow">
        <button id="optionsBtn" class="cta ghost">Game Options</button>
        <button id="endBtnModule" class="cta ghost hidden">End Session</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card hidden" id="debugCard">
      <div class="row-sb"><div>Debug</div><button id="toggleDebug" class="cta ghost" style="flex:0 0 auto">Hide</button></div>
      <pre id="debugOut" class="debug"></pre>
    </div>
  </div>

  <div class="tray">
    <div class="tray-inner">
      <div id="trayStart"><button id="startBtn" class="cta primary">Start a New Session</button></div>
      <div id="trayActive" class="hidden btnrow">
        <button id="landBtn" class="cta ok">Land</button>
        <button id="missBtn" class="cta miss">Miss</button>
        <button id="skipBtn" class="cta ghost">Skip</button>
      </div>
      <div id="trayLanded" class="hidden"><button id="nextBtnLanded" class="cta primary">Next Trick</button></div>
      <div id="trayMissed" class="hidden"><button id="nextBtnMissed" class="cta primary">Next Trick</button></div>
      <div id="trayOver" class="hidden"><button id="restartBtn" class="cta primary">Start a New Session</button></div>
    </div>
  </div>
</div>

<!-- Options -->
<dialog id="opt" class="sheet">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid rgba(255,255,255,.08)">
    <div>Game Options</div>
    <button id="closeOpt" class="iconbtn">✕</button>
  </div>
  <div style="padding:14px">
    <div class="row">
      <span class="muted">Level 1–10</span>
      <input id="level" type="range" min="1" max="10" value="7" style="flex:1"/>
      <span id="levelVal" style="font-family:ui-monospace">7</span>
    </div>
    <div class="sectionhead">
      <span class="label">Stances</span>
      <div class="row">
        <button id="stanceAllOn" class="toggle">All On</button>
        <button id="stanceAllOff" class="toggle">All Off</button>
      </div>
    </div>
    <div class="subs" id="stanceChips"></div>

    <div class="sectionhead">
      <span class="label">Obstacles</span>
      <div class="row">
        <button id="obAllOn" class="toggle">All On</button>
        <button id="obAllOff" class="toggle">All Off</button>
      </div>
    </div>
    <div class="subs" id="obChip"></div>

    <div class="sectionhead">
      <span class="label">Flip Tricks</span>
      <div class="row">
        <button id="flipAllOn" class="toggle">All On</button>
        <button id="flipAllOff" class="toggle">All Off</button>
      </div>
    </div>
    <div class="subs" id="flipChips"></div>

    <div class="sectionhead">
      <span class="label">Grinds/Slides</span>
      <div class="row">
        <button id="grindAllOn" class="toggle">All On</button>
        <button id="grindAllOff" class="toggle">All Off</button>
      </div>
    </div>
    <div class="subs" id="grindChips"></div>
  </div>
</dialog>

<!-- Settings -->
<dialog id="settings" class="sheet">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid rgba(255,255,255,.08)">
    <div>Settings</div>
    <button id="closeSettings" class="iconbtn">✕</button>
  </div>
  <div style="padding:14px" class="subs">
    <button id="useSpec" class="toggle on">Spec Scoring</button>
    <button id="useNL" class="toggle">NL Scoring</button>
    <button id="sound" class="toggle">LOUD Ding</button>
    <div style="font-size:12px;color:#8a8a96">Build v4.6.6-20250817031027</div>
  </div>
</dialog>

<script>
const bindTap=(el,fn)=>{ if(!el) return; let armed=true;
  el.addEventListener('pointerdown',()=>armed=true,{passive:true});
  el.addEventListener('pointerup',e=>{ if(!armed) return; armed=false; fn(e); },{passive:true});
  el.addEventListener('keyup',e=>{ if(e.key==='Enter'||e.key===' ') fn(e); });
};

const OBST={ "ledge":2, "flatbar":2, "rail":2, "hubba":3, "handrail":3, "box":1, "curb":1, "flat":1, "bank":1, "manual pad":1, "gap":2 };
const FLIPS=["kickflip","heelflip","varial kickflip","varial heelflip","hardflip","inward heelflip","tre flip","laser flip"];
const FLIP_MIN={ "kickflip":1, "heelflip":1, "varial kickflip":3, "varial heelflip":3, "hardflip":4, "inward heelflip":4, "tre flip":6, "laser flip":8 };
const FLIP_OBS={ "kickflip":["flat","bank","gap","manual pad","quarterpipe"], "heelflip":["flat","bank","gap","manual pad","quarterpipe"], "varial kickflip":["flat","bank","gap","quarterpipe"], "varial heelflip":["flat","bank","gap","quarterpipe"], "hardflip":["flat","bank","gap"], "inward heelflip":["flat","bank","gap"], "tre flip":["flat","bank","gap"], "laser flip":["flat","bank","gap"] };
const GRINDS=["50-50","5-0","boardslide","noseslide","tailslide","lipslide","smith","feeble","crooked","nosegrind","overcrook","bluntslide","noseblunt"];
const GRIND_MIN={ "50-50":2, "5-0":3, "boardslide":3, "noseslide":3, "tailslide":4, "lipslide":4, "smith":5, "feeble":5, "crooked":5, "nosegrind":5, "overcrook":6, "bluntslide":7, "noseblunt":8 };
const GRIND_OBS={ "50-50":["curb","box","ledge","flatbar","rail","hubba","handrail"], "5-0":["curb","box","ledge","flatbar","rail","hubba","handrail"], boardslide:["flatbar","rail","handrail"], noseslide:["curb","box","ledge"], tailslide:["curb","ledge","hubba"], lipslide:["flatbar","rail","handrail"], smith:["ledge","flatbar","rail","hubba","handrail"], feeble:["flatbar","rail","handrail"], crooked:["ledge","hubba"], nosegrind:["ledge","hubba"], overcrook:["ledge","hubba","handrail"], bluntslide:["ledge","hubba","handrail"], noseblunt:["ledge","hubba","handrail"] };

const SCORE={ stance:{ fakie:.2, nollie:.25, switch:.25 }, flip:{ "kickflip":.3, "heelflip":.35, "varial kickflip":.45, "varial heelflip":.5, "hardflip":.55, "inward heelflip":.6, "tre flip":.8, "laser flip":.85 }, spin:{ "180":.1, "360":.3 }, grind:{ "50-50":.3, "5-0":.35, boardslide:.35, noseslide:.4, tailslide:.45, lipslide:.5, smith:.6, feeble:.65, crooked:.7, nosegrind:.7, overcrook:.85, bluntslide:.8, noseblunt:.9 }, obs:{ flat:0, "manual pad":.1, box:.1, curb:.15, ledge:.25, hubba:.35, flatbar:.35, rail:.45, handrail:.55, gap:.5, bank:.25 } };

const $=id=>document.getElementById(id);
function weightedPick(a,fn){const arr=a.map(v=>({v,w:Math.max(0,fn(v))})); const tot=arr.reduce((s,o)=>s+o.w,0)||1; let r=Math.random()*tot; for(const x of arr){ if((r-=x.w)<=0) return x.v;} return arr[arr.length-1].v; }
function levelMaxTier(l){return [1,1,1,1,2,2,3,3,3,3][l-1]||3;}
function pickObstacle(l,enabled){const pool=[...enabled].filter(o=>OBST[o]<=levelMaxTier(l)); if(!pool.length) return 'flat';
  const wByL={flat:[10,9,9,8,7,6,5,4,3,2],ledge:[0,0,2,3,4,5,6,7,8,8],rail:[0,0,0,2,3,4,5,6,7,7],flatbar:[0,0,1,2,3,4,5,6,7,7],hubba:[0,0,0,1,2,4,6,7,8,9],handrail:[0,0,0,0,0,2,4,6,7,8],gap:[0,0,1,2,3,4,5,6,6,7],box:[8,8,7,7,6,5,4,3,2,2],curb:[8,8,7,7,6,5,5,4,3,2],bank:[7,7,7,6,5,4,3,3,2,2],"manual pad":[10,10,9,8,7,6,5,4,3,2]}; const L=l-1; return weightedPick(pool,o=>(wByL[o]||[1])[L]||1);}
function allowedFlipOnObs(f,o,l){return l>=FLIP_MIN[f] && (FLIP_OBS[f]||[]).includes(o);}
function allowedGrindOnObs(g,o,l){return l>=GRIND_MIN[g] && (GRIND_OBS[g]||[]).includes(o);}
function pickFlip(l,o,subs){const L=l-1; const weights={"kickflip":[10,10,9,9,8,7,6,5,4,3],"heelflip":[10,10,9,9,8,7,6,5,4,3],"varial kickflip":[0,0,6,7,8,8,7,6,5,4],"varial heelflip":[0,0,6,7,8,8,7,6,5,4],hardflip:[0,0,0,6,7,8,8,7,6,6],"inward heelflip":[0,0,0,6,7,8,8,7,6,6],"tre flip":[0,0,0,0,0,6,8,9,10,10],"laser flip":[0,0,0,0,0,0,0,6,8,10]};
  const pool=[...subs].filter(n=>allowedFlipOnObs(n,o,l)); return pool.length?weightedPick(pool,n=>(weights[n]||[])[L]||1):null;}
function pickGrind(l,o,subs){const L=l-1; const weights={"50-50":[0,7,8,9,9,9,9,8,7,6],"5-0":[0,0,7,8,9,9,9,8,7,6],boardslide:[0,0,6,8,9,9,9,8,7,6],noseslide:[0,0,6,8,9,9,8,7,6,5],tailslide:[0,0,0,6,8,9,9,8,7,6],lipslide:[0,0,0,6,8,9,9,8,7,6],smith:[0,0,0,0,6,8,9,9,8,7],feeble:[0,0,0,0,6,8,9,9,8,7],crooked:[0,0,0,0,6,8,9,9,8,7],nosegrind:[0,0,0,0,6,8,9,9,8,7],overcrook:[0,0,0,0,0,6,8,9,9,9],bluntslide:[0,0,0,0,0,0,6,8,9,9],noseblunt:[0,0,0,0,0,0,0,6,8,9]};
  const pool=[...subs].filter(n=>allowedGrindOnObs(n,o,l)); return pool.length?weightedPick(pool,n=>(weights[n]||[])[L]||1):null;}

function patternList(level, obstacle, hasFlip, hasGrind){
  const grindable=new Set(["ledge","flatbar","rail","hubba","handrail","box","curb"]);
  const canGrind = grindable.has(obstacle) && hasGrind;
  const out=[];
  if(hasFlip) out.push("flip-only");
  if(canGrind) out.push("grind-only");
  if(level>=5 && hasFlip && canGrind) out.push("flip→grind","grind→flip out");
  if(level>=7 && hasFlip && canGrind) out.push("spin+flip→grind","flip→grind+spin out","grind→flip+spin out","spin→grind+flip out");
  if(level>=9 && hasFlip && canGrind) out.push("spin+flip→grind→spin+flip out");
  return out;
}

function toText(t){
  const parts=[];
  if(t.stance && t.stance!=="regular") parts.push(t.stance);
  if(t.spinIn) parts.push(t.spinIn+"°");
  if(t.flipIn) parts.push(t.flipIn);
  if(t.grind) parts.push((t.direction||"FS")+" "+t.grind);
  if(t.flipOut || t.spinOut){
    let out="";
    if(t.flipOut) out+=t.flipOut+" ";
    if(t.spinOut) out+=t.spinOut+"° ";
    parts.push("+ "+out.trim()+" out");
  }
  parts.push("on "+t.obstacle);
  return parts.join(" ").replace(/\s+/g," ").trim();
}

const $=id=>document.getElementById(id);
const ui={trickText:$("trickText"),subText:$("subText"),attempts:$("attempts"),scorePeek:$("scorePeek"),
levelBadge:$("levelBadge"),modeBadge:$("modeBadge"),
trayStart:$("trayStart"),trayActive:$("trayActive"),trayLanded:$("trayLanded"),trayMissed:$("trayMissed"),trayOver:$("trayOver"),
startBtn:$("startBtn"),landBtn:$("landBtn"),missBtn:$("missBtn"),skipBtn:$("skipBtn"),nextBtnLanded:$("nextBtnLanded"),nextBtnMissed:$("nextBtnMissed"),restartBtn:$("restartBtn"),
optionsBtn:$("optionsBtn"),opt:$("opt"),closeOpt:$("closeOpt"),
stanceChips:$("stanceChips"),obChip:$("obChip"),flipChips:$("flipChips"),grindChips:$("grindChips"),
stanceAllOn:$("stanceAllOn"),stanceAllOff:$("stanceAllOff"),obAllOn:$("obAllOn"),obAllOff:$("obAllOff"),
flipAllOn:$("flipAllOn"),flipAllOff:$("flipAllOff"),grindAllOn:$("grindAllOn"),grindAllOff:$("grindAllOff"),
level:$("level"),levelVal:$("levelVal"),
settings:$("settings"),settingsBtn:$("settingsBtn"),closeSettings:$("closeSettings"),
useSpec:$("useSpec"),useNL:$("useNL"),sound:$("sound"),
scoreVal:$("scoreVal"),streakVal:$("streakVal"),highVal:$("highVal"),skTop:$("skTop"),
endBtnModule:$("endBtnModule"), debugBtn:$("debugBtn"), debugCard:$("debugCard"), debugOut:$("debugOut"), toggleDebug:$("toggleDebug")};

const App={ level:7, stances:new Set(["regular","fakie","nollie","switch"]), obstacles:new Set(Object.keys(OBST)), flips:new Set(FLIPS), grinds:new Set(GRINDS),
  flow:0, score:0, letters:0, attempt:1, tray:"start", current:null, misses:[], lands:[], scoring:"spec", sound:false };

function setTray(s){ ["trayStart","trayActive","trayLanded","trayMissed","trayOver"].forEach(id=>ui[id].classList.add("hidden"));
  ui["tray"+s[0].toUpperCase()+s.slice(1)].classList.remove("hidden"); App.tray=s; renderAttempts(); }
function renderAttempts(){ ui.attempts.innerHTML=""; for(let i=1;i<=3;i++){ const d=document.createElement("div"); d.className="dot"; if(i===App.attempt && App.tray==="active") d.classList.add("active"); if(App.misses.includes(i)){const m=document.createElement("div");m.className="m";m.textContent="×";d.appendChild(m);} if(App.tray==="landed" && App.lands.includes(i)){const m=document.createElement("div");m.className="m";m.textContent="✓";d.appendChild(m);} ui.attempts.appendChild(d); } }
function letters(n){ Array.from(ui.skTop.children).forEach((el,i)=>el.classList.toggle("on",i<n)); }
function updateHUD(){ ui.levelBadge.textContent="Level "+App.level; ui.streakVal.textContent=App.flow; ui.scoreVal.textContent=App.score; letters(App.letters); const p=predict(); ui.scorePeek.textContent=p?("This attempt: +"+p.total):""; ui.endBtnModule.classList.toggle("hidden", App.tray!=="active" && App.tray!=="landed" && App.tray!=="missed"); dumpDebug(); }

function chooseTrick(){
  const MAX_TRIES=200;
  for(let tries=0; tries<MAX_TRIES; tries++){
    const ob = pickObstacle(App.level, App.obstacles);
    const hasFlip = App.flips.size>0;
    const hasGrind = App.grinds.size>0;
    const patterns = patternList(App.level, ob, hasFlip, hasGrind);
    if(!patterns.length) continue;
    const pat = weightedPick(patterns, p=> (App.level<=6? (p.includes("→")?5:(p==="flip-only"?8:6)) : (p.includes("→")?8:5)) );
    const t={obstacle:ob, stance: weightedPick([...App.stances], s=>({regular:10,fakie:3,nollie:3,switch:3}[s]||1))};
    const dir=Math.random()<.5?"FS":"BS";
    const f = hasFlip ? pickFlip(App.level, ob, App.flips) : null;
    const f2 = hasFlip ? pickFlip(App.level, ob, App.flips) : null;
    const g = hasGrind ? pickGrind(App.level, ob, App.grinds) : null;
    const spin = (lvl)=> (Math.random() < (lvl>=7?0.65:(lvl>=4?0.25:0.05)) ? (Math.random()<0.7?180:360) : null);

    if(pat==="flip-only"){ if(!f) continue; t.flipIn=f; }
    else if(pat==="grind-only"){ if(!g) continue; t.grind=g; t.direction=dir; }
    else if(pat==="flip→grind"){ if(!f||!g) continue; t.flipIn=f; t.grind=g; t.direction=dir; }
    else if(pat==="grind→flip out"){ if(!g||(!f&&!f2)) continue; t.grind=g; t.direction=dir; t.flipOut=f||f2; }
    else if(pat==="spin+flip→grind"){ const sp=spin(App.level); if(!sp||!f||!g) continue; t.spinIn=sp; t.flipIn=f; t.grind=g; t.direction=dir; }
    else if(pat==="flip→grind+spin out"){ const sp=spin(App.level)||180; if(!f||!g) continue; t.flipIn=f; t.grind=g; t.direction=dir; t.spinOut=sp; }
    else if(pat==="grind→flip+spin out"){ const sp=spin(App.level)||180; if(!g||(!f&&!f2)) continue; t.grind=g; t.direction=dir; t.flipOut=f||f2; t.spinOut=sp; }
    else if(pat==="spin→grind+flip out"){ const sp=spin(App.level)||180; if(!g||(!f&&!f2)) continue; t.spinIn=sp; t.grind=g; t.direction=dir; t.flipOut=f||f2; }
    else if(pat==="spin+flip→grind→spin+flip out"){ const sp1=spin(App.level)||180; const sp2=360; if(!f||!g) continue; t.spinIn=sp1; t.flipIn=f; t.grind=g; t.direction=dir; t.spinOut=sp2; t.flipOut=f2||f; }

    if(pat.includes("grind") && !t.grind) continue;
    if(pat.includes("flip") && !t.flipIn && !t.flipOut) continue;

    t.pattern=pat; return t;
  }
  return {obstacle:'flat', stance:'regular', flipIn:'kickflip', pattern:'flip-only'};
}

function predict(){
  if(!App.current) return null;
  const t=App.current;
  let base=1.0;
  if(t.flipIn) base+=(SCORE.flip[t.flipIn]||0);
  if(t.flipOut) base+=((SCORE.flip[t.flipOut]||0)*0.9);
  if(t.spinIn) base+=(SCORE.spin[String(t.spinIn)]||0);
  if(t.spinOut) base+=((SCORE.spin[String(t.spinOut)]||0)*0.9);
  if(t.grind) base+=(SCORE.grind[t.grind]||0);
  base+=(SCORE.obs[t.obstacle]||0);
  const attemptM=({1:1,2:.85,3:.75}[App.attempt]||1);
  const flowM=1+Math.min(App.flow*0.03,0.15);
  const total=Math.round(100*base*attemptM*flowM);
  return {base,attemptM,flowM,total};
}

function nextTrick(){
  App.current = chooseTrick();
  App.attempt=1; App.misses=[]; App.lands=[];
  ui.trickText.textContent = toText(App.current);
  ui.subText.textContent = "Attempt 1 of 3";
  renderAttempts(); updateHUD();
  setTray("active");
}

function land(){
  const s=predict(); App.score+=s.total; App.flow+=1; App.lands.push(App.attempt);
  setTray("landed"); ui.subText.textContent="+"+s.total; updateHUD();
}
function miss(){
  App.misses.push(App.attempt);
  if(App.attempt>=3){ App.flow=0; App.letters=Math.min(5,(App.letters||0)+1); setTray("missed"); }
  else { App.attempt+=1; setTray("active"); ui.subText.textContent="Miss (attempt "+App.attempt+" of 3)"; }
  updateHUD();
}
function skip(){ App.flow=0; nextTrick(); }

// bindings
const bind=(el,fn)=>{ el&&el.addEventListener('pointerup',fn,{passive:true}); el&&el.addEventListener('keyup',e=>{if(e.key==='Enter'||e.key===' ')fn(e);}); };
bind(ui.startBtn,()=>{nextTrick();});
bind(ui.restartBtn,()=>{App.score=0;App.flow=0;App.letters=0;nextTrick();});
bind(ui.landBtn,land); bind(ui.missBtn,miss); bind(ui.skipBtn,skip);
bind(ui.nextBtnLanded,()=>{nextTrick();});
bind(ui.nextBtnMissed,()=>{nextTrick();});
bind(ui.optionsBtn,()=>ui.opt.showModal()); bind(ui.closeOpt,()=>ui.opt.close());
bind(ui.settingsBtn,()=>ui.settings.showModal()); bind(ui.closeSettings,()=>ui.settings.close());
bind(ui.useSpec,()=>{ui.useSpec.classList.add("on"); ui.useNL.classList.remove("on"); App.scoring="spec";});
bind(ui.useNL,()=>{ui.useNL.classList.add("on"); ui.useSpec.classList.remove("on"); App.scoring="nl";});
bind(ui.sound,()=>{ui.sound.classList.toggle("on"); App.sound=!App.sound;});
bind(ui.debugBtn,()=>{ui.debugCard.classList.toggle("hidden"); dumpDebug();});
bind(ui.toggleDebug,()=>{ui.debugCard.classList.add("hidden");});

function chip(container, label, set){const el=document.createElement("div"); el.className="toggle"+(set.has(label)?" on":""); el.textContent=label; bind(el,()=>{ if(set.has(label)) set.delete(label); else set.add(label); el.classList.toggle("on"); dumpDebug(); }); container.appendChild(el); return el;}
function renderChips(){ ui.stanceChips.innerHTML=""; ["regular","fakie","nollie","switch"].forEach(s=>chip(ui.stanceChips,s,App.stances));
  ui.obChip.innerHTML=""; Object.keys(OBST).forEach(o=>chip(ui.obChip,o,App.obstacles));
  ui.flipChips.innerHTML=""; FLIPS.forEach(f=>chip(ui.flipChips,f,App.flips));
  ui.grindChips.innerHTML=""; GRINDS.forEach(g=>chip(ui.grindChips,g,App.grinds)); }
renderChips();

function setAll(set, list, on){ if(on) list.forEach(x=>set.add(x)); else list.forEach(x=>set.delete(x)); renderChips(); dumpDebug(); }
bind(document.getElementById("stanceAllOn"),()=>setAll(App.stances,["regular","fakie","nollie","switch"],true));
bind(document.getElementById("stanceAllOff"),()=>setAll(App.stances,["regular","fakie","nollie","switch"],false));
bind(document.getElementById("obAllOn"),()=>setAll(App.obstacles,Object.keys(OBST),true));
bind(document.getElementById("obAllOff"),()=>setAll(App.obstacles,Object.keys(OBST),false));
bind(document.getElementById("flipAllOn"),()=>setAll(App.flips,FLIPS,true));
bind(document.getElementById("flipAllOff"),()=>setAll(App.flips,FLIPS,false));
bind(document.getElementById("grindAllOn"),()=>setAll(App.grinds,GRINDS,true));
bind(document.getElementById("grindAllOff"),()=>setAll(App.grinds,GRINDS,false));

ui.level.addEventListener("input",e=>{App.level=+e.target.value; ui.levelVal.textContent=App.level; dumpDebug();});

bind(ui.scorePeek,()=>{const s=predict(); if(!s) return; alert(["If you land now:","Base: "+s.base.toFixed(2),"Attempt ×"+s.attemptM.toFixed(2),"Flow ×"+s.flowM.toFixed(2),"Total: "+s.total].join("\n"));});

function dumpDebug(){ const snap={level:App.level, stances:[...App.stances], obstacles:[...App.obstacles], flips:[...App.flips], grinds:[...App.grinds], current:App.current}; if(ui.debugOut) ui.debugOut.textContent = JSON.stringify(snap,null,2); }

setTray("start"); updateHUD();

if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js?v=v4.6.6-20250817031027').catch(()=>{}); }
</script>
</body></html>
